<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detentions ‚Äî MIS 2.0</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{
      --bg:#f3f6fb; --card:#ffffff; --muted:#98a0b3; --accent:#1fb6ff; --accent-2:#3f51b5;
      --success:#2ecc71; --danger:#ff5252; --warning:#ff8a00; --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, 'Segoe UI', Roboto, Arial, sans-serif;background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 40%);color:#263147}

    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--accent-2),#263159);color:#fff;padding:22px 18px;display:flex;flex-direction:column;gap:18px}
    .brand{font-weight:700;font-size:18px;display:flex;align-items:center;gap:12px}
    .brand i{font-size:22px;opacity:0.95}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .nav a{display:flex;align-items:center;gap:12px;color:rgba(255,255,255,0.9);text-decoration:none;padding:10px;border-radius:8px;font-size:14px}
    .nav a.active{background:rgba(255,255,255,0.06);font-weight:600}

    main{flex:1;padding:22px;display:flex;flex-direction:column;gap:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .breadcrumbs{color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:10px;align-items:center}
    .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:var(--accent-2);border:1px solid rgba(33,150,243,0.12)}
    .btn.danger{background:#ff5252;color:white}

    .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(31,182,255,0.05);}

    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .header h1{margin:0;color:#263147}
    .stat-badge{background:var(--danger);color:white;padding:8px 14px;border-radius:8px;font-weight:700;font-size:14px}

    .detention-grid{display:grid;gap:14px}
    .detention-card{background:linear-gradient(180deg,rgba(255,82,82,0.05),rgba(255,235,238,0.6));border:1px solid rgba(255,82,82,0.12);border-radius:12px;padding:16px;display:flex;align-items:center;gap:14px}
    .detention-card.severe{border-left:4px solid var(--danger);box-shadow:0 4px 12px rgba(255,82,82,0.15)}

    .detention-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent-2),#7b61ff);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}

    .detention-info{flex:1}
    .detention-info h3{margin:0 0 4px 0;font-weight:800;color:#d32f2f;font-size:16px;text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 2px 4px rgba(211,47,47,0.1)}
    .detention-reason{font-size:13px;color:var(--muted);margin:2px 0}
    .detention-reason strong{color:#ff5252}

    .detention-actions{display:flex;gap:8px}
    .btn-small{padding:6px 10px;font-size:12px;border-radius:6px;border:0;cursor:pointer;font-weight:600}
    .btn-small.resolve{background:#2ecc71;color:white}
    .btn-small.note{background:transparent;border:1px solid rgba(33,150,243,0.12);color:var(--accent-2)}

    .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty-state i{font-size:48px;opacity:0.3;margin-bottom:12px}

    .filter-bar{display:flex;gap:8px;margin-bottom:12px}
    .filter-btn{padding:8px 12px;border-radius:6px;border:1px solid rgba(33,150,243,0.12);background:transparent;color:var(--accent-2);cursor:pointer;font-weight:600;font-size:13px}
    .filter-btn.active{background:var(--accent);color:white;border-color:var(--accent)}

    @media (max-width:640px){
      .sidebar{display:none}
      .detention-card{flex-direction:column;align-items:flex-start}
      .detention-actions{width:100%;margin-top:10px}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><i class="fas fa-school"></i> MIS 2.0</div>
      <nav class="nav">
        <a href="index.html"><i class="fas fa-home"></i> Dashboard</a>
        <a href="teacher_attendance.html"><i class="fas fa-list-ul"></i> Attendance</a>
        <a href="behavior_register.html"><i class="fas fa-child"></i> Behaviour</a>
        <a href="detentions.html" class="active"><i class="fas fa-ban"></i> Detentions</a>
        <a href="pa_system.html"><i class="fas fa-megaphone"></i> PA System</a>
        <a href="school_bell.html"><i class="fas fa-bell"></i> School Bell</a>
      </nav>
      <div style="margin-top:auto;font-size:13px;opacity:0.9">Detention List</div>
    </aside>

    <main>
      <div class="topbar">
        <div>
          <div class="breadcrumbs">My Dashboard ‚Ä∫ <strong style="color:var(--accent-2)">Detentions</strong></div>
          <h1 style="margin:8px 0 0 0">Student Detentions</h1>
        </div>
        <div class="top-actions">
          <span class="stat-badge" id="detentionCount">0 in detention</span>
          <button class="btn ghost" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
          <button class="btn ghost" id="exportBtn"><i class="fas fa-file-export"></i> Export</button>
        </div>
      </div>

      <div class="card">
        <div style="margin-bottom:14px">
          <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">All Detentions</button>
            <button class="filter-btn" data-filter="attendance">Attendance (2+ Lates)</button>
            <button class="filter-btn" data-filter="behaviour">Behaviour (2+ Code-4s)</button>
            <button class="filter-btn" data-filter="multiple">Multiple Issues</button>
          </div>
        </div>

        <div id="detentionList" class="detention-grid">
          <!-- populated by JS -->
        </div>
      </div>
    </main>
  </div>

  <script>
    const SERVER_BASE = 'http://localhost:4000';

    let detentions = [];
    let allStudents = [];
    let currentFilter = 'all';

    async function loadData(){
      try{
        // Load roster
        const rosterResp = await fetch(SERVER_BASE + '/api/state/roster');
        if(rosterResp.ok){
          const rosterJson = await rosterResp.json();
          if(rosterJson.data) allStudents = rosterJson.data;
        }

        // Load attendance (for lates)
        const attResp = await fetch(SERVER_BASE + '/api/state/attendance');
        if(attResp.ok){
          const attJson = attResp.json();
          // Will use client-side logic if needed
        }

        // Load behaviour (for code-4s)
        const behResp = await fetch(SERVER_BASE + '/api/state/behavior');
        if(behResp.ok){
          const behJson = await behResp.json();
          // Will use client-side logic if needed
        }
      }catch(e){
        console.error('Load error:', e);
      }

      // Build detentions from local storage for now
      buildDetentions();
    }

    function buildDetentions(){
      detentions = [];

      // Check attendance page for lates
      try{
        const attStr = localStorage.getItem('attendance_state_v1');
        if(attStr){
          const attStudents = JSON.parse(attStr);
          attStudents.forEach(s=>{
            if(s.lates && s.lates >= 2){
              let existing = detentions.find(d=>d.id===s.id);
              if(!existing){
                existing = {id:s.id, name:s.name, reasons:[]};
                detentions.push(existing);
              }
              existing.reasons.push({type:'attendance', detail:`${s.lates} lates`});
              existing.category = 'attendance';
            }
          });
        }
      }catch(e){}

      // Check behaviour page for code-4s (code 4 = "Unsatisfactory")
      try{
        const behStr = localStorage.getItem('behavior_state_v1');
        if(behStr){
          const behData = JSON.parse(behStr);
          if(behData && behData.entries){
            const code4Count = {};
            behData.entries.forEach(entry=>{
              if(entry.value === '4'){
                code4Count[entry.id] = (code4Count[entry.id] || 0) + 1;
              }
            });
            Object.entries(code4Count).forEach(([id, count])=>{
              if(count >= 2){
                let existing = detentions.find(d=>d.id===id);
                if(!existing){
                  const student = allStudents.find(s=>s.id===id);
                  existing = {id:id, name:student?.name||id, reasons:[]};
                  detentions.push(existing);
                } else {
                  if(existing.category !== 'multiple') existing.category = 'multiple';
                }
                existing.reasons.push({type:'behaviour', detail:`${count} Code-4 marks`});
                if(!existing.category) existing.category = 'behaviour';
              }
            });
          }
        }
      }catch(e){}

      // Mark multiple detentions
      detentions.forEach(d=>{
        if(d.reasons && d.reasons.length > 1) d.category = 'multiple';
      });

      renderDetentions();
    }

    function renderDetentions(){
      const container = document.getElementById('detentionList');
      const filtered = currentFilter === 'all'
        ? detentions
        : detentions.filter(d=>d.category === currentFilter || (currentFilter === 'multiple' && d.reasons.length > 1));

      document.getElementById('detentionCount').textContent = detentions.length + ' in detention';

      if(filtered.length === 0){
        container.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle"></i><h2>No Detentions</h2><p>All students are in good standing.</p></div>`;
        return;
      }

      container.innerHTML = filtered.map(d=>`
        <div class="detention-card${d.reasons.length > 1 ? ' severe' : ''}">
          <div class="detention-avatar">${(d.name||'?')[0].toUpperCase()}</div>
          <div class="detention-info">
            <h3><span style="background:linear-gradient(120deg,#ff5252,#ff8a80);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">${d.name}</span> <small style="color:var(--muted);font-weight:400;text-transform:none;font-size:12px;letter-spacing:0">${d.id}</small></h3>
            ${d.reasons.map(r=>`<div class="detention-reason"><strong>${r.type === 'attendance' ? 'üìç Attendance:' : '‚ö†Ô∏è  Behaviour:'}</strong> ${r.detail}</div>`).join('')}
          </div>
          <div class="detention-actions">
            <button class="btn-small resolve" onclick="resolveDetention('${d.id}')">Resolve</button>
            <button class="btn-small note" onclick="addNote('${d.id}')">Note</button>
          </div>
        </div>
      `).join('');
    }

    function resolveDetention(id){
      // In a real system, this would post to server
      alert(`Detention for ${id} marked as resolved. (Feature in development)`);
    }

    function addNote(id){
      const note = prompt(`Add note for ${id}:`);
      if(note) alert(`Note saved. (Feature in development)`);
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        renderDetentions();
      });
    });

    // Refresh
    document.getElementById('refreshBtn').addEventListener('click', ()=>{
      loadData();
      alert('Detention list refreshed.');
    });

    // Export
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const csv = ['id,name,reasons'].concat(detentions.map(d=>`${d.id},"${d.name}","${d.reasons.map(r=>r.detail).join('; ')}"`)).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='detentions.csv'; a.click();
    });

    // Init
    loadData();
    setInterval(loadData, 30000); // refresh every 30 seconds
  </script>
</body>
</html>
