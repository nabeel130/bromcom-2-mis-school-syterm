<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Behaviour Register — MIS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--blue:#1e88e5;--accent:#00a9a5;--muted:#6b7280;--bg:#f7fafc;--card:#fff;--danger:#ef4444;--highlight:#fff59d}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, 'Segoe UI', Arial;background:var(--bg);color:#1f2937}
    .layout{display:flex;min-height:100vh}

    /* Left vertical nav */
    .leftnav{width:72px;background:linear-gradient(180deg,var(--blue),#0b5fb3);color:#fff;display:flex;flex-direction:column;align-items:center;padding:18px 8px;gap:12px}
    .leftnav a{color:#fff;text-decoration:none;display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px}
    .leftnav .logo{font-weight:800;color:#fff;font-size:18px;margin-bottom:6px}

    /* Main content */
    .main{flex:1;padding:18px}
    .top-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{padding:10px 14px;border-radius:6px;border:0;cursor:pointer;font-weight:700}
    .btn.save{background:#22c55e;color:#fff}
    .btn.close{background:#1f2937;color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}

    .meta{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .meta .date-pill{background:#e6f2ff;color:var(--blue);padding:6px 10px;border-radius:999px;font-weight:700}

    .grid-wrap{display:flex;gap:14px}

    /* Student list + date grid */
    .register{flex:1;background:var(--card);border-radius:8px;padding:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);overflow:auto}
    .register table{width:100%;border-collapse:collapse;font-size:13px}
    .register thead th{position:sticky;top:0;background:#f1f6fb;padding:10px;border-bottom:1px solid #e6eef9;text-align:left}
    .register tbody td{padding:10px;border-bottom:1px solid #f0f4f8}
    .name-col{width:260px;font-weight:700}
    .name-col.detained{color:#d32f2f;background:#ffebee}
    .smallcol{width:48px;text-align:center}

    /* behavior code cells: compact style */
    .behavior-cell{width:56px;height:44px;text-align:center;vertical-align:middle;cursor:pointer;border-radius:6px;background:transparent;font-weight:700;display:flex;align-items:center;justify-content:center}
    .behavior-cell.code-empty{background:#f5f5f5;color:var(--muted);font-weight:400}
    .behavior-cell.code-1{background:#c8e6c9;color:#2e7d32}
    .behavior-cell.code-2{background:#bbdefb;color:#1565c0}
    .behavior-cell.code-3{background:#fff3cd;color:#856404}
    .behavior-cell.code-4{background:#ffcdd2;color:#c62828;font-weight:800}
    .behavior-cell.code-5{background:#f3e5f5;color:#6a1b9a;font-weight:800}
    .behavior-cell.highlight{background:var(--highlight)}
    .behavior-cell.now{background:#cfe8ff}

    /* Popup menu for behavior codes */
    .behavior-menu{position:fixed;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:1000;padding:4px}
    .behavior-menu button{display:block;width:100%;padding:10px 16px;border:0;background:transparent;cursor:pointer;font-weight:600;text-align:left;border-radius:4px}
    .behavior-menu button:hover{background:#f5f5f5}
    .behavior-menu .code-btn-1{color:#2e7d32}
    .behavior-menu .code-btn-2{color:#1565c0}
    .behavior-menu .code-btn-3{color:#856404}
    .behavior-menu .code-btn-4{color:#c62828}
    .behavior-menu .code-btn-5{color:#6a1b9a}
    .behavior-menu .code-btn-clear{color:var(--muted)}

    /* right sidebar student info */
    .sidebar{width:300px;background:var(--card);border-radius:8px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06);height:fit-content}
    .avatar{width:96px;height:96px;border-radius:999px;background:#e8eefb;margin:auto}
    .s-info{text-align:center;margin-top:10px}
    .s-info h3{margin:6px 0;color:inherit}
    .stat{display:flex;justify-content:space-between;padding:6px 0;border-top:1px solid #f1f4f8;margin-top:12px;color:var(--muted)}
    .detention-alert{background:#ffebee;padding:12px;border-radius:6px;color:#c62828;font-weight:700;margin-top:12px;border-left:4px solid #d32f2f}

    /* footer */
    .legend{margin-top:12px;font-size:13px;color:var(--muted)}

    @media (max-width:960px){.grid-wrap{flex-direction:column}.sidebar{width:100%}}
  </style>
</head>
<body>
  <div class="layout">
    <nav class="leftnav">
      <div class="logo">B</div>
      <a title="Home" href="#"><i class="fas fa-home"></i></a>
      <a title="Students" href="#"><i class="fas fa-user-graduate"></i></a>
      <a title="Reports" href="#"><i class="fas fa-chart-bar"></i></a>
      <a title="Config" href="#"><i class="fas fa-cog"></i></a>
    </nav>

    <main class="main">
      <div class="top-actions">
        <button class="btn save" id="saveBtn"><i class="fas fa-save"></i> Save</button>
        <button class="btn close" id="closeBtn"><i class="fas fa-times"></i> Close</button>
        <button class="btn ghost" id="undoBtn"><i class="fas fa-rotate-left"></i> Undo</button>
        <button class="btn ghost" id="backBtn"><i class="fas fa-arrow-left"></i> Go Back to Register</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <div class="date-pill">Today</div>
          <div class="small-muted" id="summaryText">Loading...</div>
        </div>
      </div>

      <div class="grid-wrap">
        <section class="register">
          <table id="regTable">
            <thead>
              <tr>
                <th class="name-col">Student Name</th>
                <!-- date columns generated by JS -->
              </tr>
            </thead>
            <tbody id="regBody">
              <!-- rows by JS -->
            </tbody>
          </table>
        </section>

        <aside class="sidebar">
          <div class="avatar"></div>
          <div class="s-info">
            <h3 id="sideName">Select a student</h3>
            <div class="sub" id="sideDob"></div>
            <div class="sub" id="sideId"></div>
          </div>
          <div class="stat"><div>Excellent (1)</div><div id="sideCode1">0</div></div>
          <div class="stat"><div>Good (2)</div><div id="sideCode2">0</div></div>
          <div class="stat"><div>Disruptive (3)</div><div id="sideCode3">0</div></div>
          <div class="stat"><div>Poor (4)</div><div id="sideCode4">0</div></div>
          <div class="stat"><div>Unsafe (5)</div><div id="sideCode5">0</div></div>
          <div class="stat"><div>Lates (/)</div><div id="sideLates">0</div></div>
          <div id="detentionContainer"></div>
          <div class="legend"><strong>Codes:</strong> 1=Excellent, 2=Good, 3=Disruptive, 4=Poor, 5=Unsafe, /=Late</div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    // Build example register with many date columns
    const students = [
      'ALI, VICTORIA','BATESON, KIRSTY','BURNS, ANJALI','DARBAR, OWEN','DEVLIN, EMMA','DHLIWAYO, JAMES','DOBSON, DANIEL','DUGDILL, SEETLE','FIGGINS, MUHAMMED-ALI','FOSTER, LYNN','FOSTER, YASHVI','GOODIER, HARRIS','GREENHALGH, NATHAN','HIRANI, GARY'
    ].map((n,i)=>({id:100+i,name:n,cells:[],detained:false}));

    // generate a set of columns (dates) to mimic many date columns
    const columns = [];
    for(let i=0;i<14;i++){
      const weekday = ['Mo','Tu','We','Th','Fr','Sa','Su'][i%7];
      const day = 25 + Math.floor(i/2);
      const part = (i%2===0)?'AM':'PM';
      columns.push(`${weekday} ${day} ${part}`);
    }

    // insert date headers
    const theadRow = document.querySelector('#regTable thead tr');
    columns.forEach((c,idx)=>{
      const th = document.createElement('th');
      th.innerHTML = `<div style="display:flex;flex-direction:column"><small style="color:var(--muted);font-weight:600">${c}</small></div>`;
      theadRow.appendChild(th);
    });

    // populate rows
    const tbody = document.getElementById('regBody');
    students.forEach((s,si)=>{
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      nameTd.className = 'name-col';
      nameTd.dataset.studentIdx = si;
      nameTd.textContent = s.name;
      tr.appendChild(nameTd);

      s.cells = new Array(columns.length).fill(0); // 0 = empty, 1-5 = codes, "/" = late
      columns.forEach((col,ci)=>{
        const td = document.createElement('td');
        td.className = 'behavior-cell code-empty';
        td.textContent = '—';
        td.dataset.r = si;
        td.dataset.c = ci;
        td.addEventListener('click', onCellClick);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // Behavior code definitions
    const codeMap = {
      0: { label: '—', class: 'code-empty', name: 'Empty' },
      1: { label: '1', class: 'code-1', name: 'Excellent' },
      2: { label: '2', class: 'code-2', name: 'Good' },
      3: { label: '3', class: 'code-3', name: 'Disruptive' },
      4: { label: '4', class: 'code-4', name: 'Poor' },
      5: { label: '5', class: 'code-5', name: 'Unsafe' },
      '/': { label: '/', class: 'code-3', name: 'Late' }
    };

    function updateDetentionStatus(studentIdx){
      const student = students[studentIdx];
      const code4Count = student.cells.filter(c=>c===4).length;
      const lateCount = student.cells.filter(c=>c==='/').length;
      student.detained = (code4Count >= 2) || (lateCount >= 2);
      updateStudentNameHighlight(studentIdx);
      if(studentIdx === currentStudentIdx){
        updateSidebar();
      }
    }

    function updateStudentNameHighlight(studentIdx){
      const student = students[studentIdx];
      const nameTd = document.querySelector(`td[data-student-idx="${studentIdx}"]`);
      if(student.detained){
        nameTd.classList.add('detained');
      } else {
        nameTd.classList.remove('detained');
      }
    }

    let currentStudentIdx = -1;

    function onCellClick(e){
      const el = e.currentTarget;
      const r = parseInt(el.dataset.r);
      const c = parseInt(el.dataset.c);

      currentStudentIdx = r;
      updateSidebar();

      // Show behavior code menu
      showBehaviorMenu(el, r, c);
    }

    function showBehaviorMenu(cellEl, r, c){
      // Remove existing menu
      const existing = document.querySelector('.behavior-menu');
      if(existing) existing.remove();

      const menu = document.createElement('div');
      menu.className = 'behavior-menu';
      
      const rect = cellEl.getBoundingClientRect();
      menu.style.left = (rect.left + 10) + 'px';
      menu.style.top = (rect.bottom + 5) + 'px';

      [1,2,3,4,5,'/',0].forEach(code=>{
        const btn = document.createElement('button');
        btn.className = `code-btn-${code === 0 ? 'clear' : code}`;
        if(code === 0){
          btn.textContent = '✕ Clear';
        } else if(code === '/'){
          btn.textContent = '/ Late';
        } else {
          btn.textContent = `${code} — ${codeMap[code].name}`;
        }
        btn.addEventListener('click', ()=>{
          setCellValue(r, c, code);
          menu.remove();
        });
        menu.appendChild(btn);
      });

      document.body.appendChild(menu);
      // Close menu on Escape
      const closeOnEscape = (e)=>{
        if(e.key==='Escape'){
          menu.remove();
          document.removeEventListener('keydown', closeOnEscape);
        }
      };
      document.addEventListener('keydown', closeOnEscape);
    }

    function setCellValue(r, c, code){
      const student = students[r];
      student.cells[c] = code;

      const cell = document.querySelector(`.behavior-cell[data-r="${r}"][data-c="${c}"]`);
      cell.classList.remove(...Object.values(codeMap).map(m=>m.class));
      cell.classList.add(codeMap[code].class);
      cell.textContent = codeMap[code].label;

      updateDetentionStatus(r);
      saveState();
    }

    function updateSidebar(){
      if(currentStudentIdx < 0) return;
      const student = students[currentStudentIdx];
      document.getElementById('sideName').textContent = student.name;
      document.getElementById('sideDob').textContent = `ID: ${student.id}`;
      document.getElementById('sideId').textContent = '';

      const code1Count = student.cells.filter(c=>c===1).length;
      const code2Count = student.cells.filter(c=>c===2).length;
      const code3Count = student.cells.filter(c=>c===3).length;
      const code4Count = student.cells.filter(c=>c===4).length;
      const code5Count = student.cells.filter(c=>c===5).length;
      const lateCount = student.cells.filter(c=>c==='/').length;

      document.getElementById('sideCode1').textContent = code1Count;
      document.getElementById('sideCode2').textContent = code2Count;
      document.getElementById('sideCode3').textContent = code3Count;
      document.getElementById('sideCode4').textContent = code4Count;
      document.getElementById('sideCode5').textContent = code5Count;
      document.getElementById('sideLates').textContent = lateCount;

      const detentionContainer = document.getElementById('detentionContainer');
      if(student.detained){
        detentionContainer.innerHTML = '<div class="detention-alert"><i class="fas fa-exclamation-circle"></i> DETENTION: 2+ Poor marks or 2+ Lates</div>';
      } else {
        detentionContainer.innerHTML = '';
      }
    }

    // --- Persistence & Midnight Reset logic ---
    const STATE_KEY = 'behavior_register_state_v1';
    const LAST_RESET_KEY = 'behavior_register_lastReset_v1';

    function todayStr(){
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    function saveState(){
      const payload = students.map((s,i)=>({ idx: i, cells: s.cells }));
      localStorage.setItem(STATE_KEY, JSON.stringify(payload));
      // Try server sync
      trySaveToServer();
    }

    function loadState(){
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw) return false;
      try{
        const payload = JSON.parse(raw);
        payload.forEach(item=>{
          students[item.idx].cells = item.cells || [];
          item.cells.forEach((code,ci)=>{
            const cell = document.querySelector(`.behavior-cell[data-r="${item.idx}"][data-c="${ci}"]`);
            if(cell){
              cell.classList.remove(...Object.values(codeMap).map(m=>m.class));
              cell.classList.add(codeMap[code].class);
              cell.textContent = codeMap[code].label;
            }
            updateDetentionStatus(item.idx);
          });
        });
        return true;
      }catch(e){return false}
    }

    function performReset(){
      students.forEach((s,i)=>{
        s.cells = new Array(columns.length).fill(0);
        s.detained = false;
        document.querySelectorAll(`.behavior-cell[data-r="${i}"]`).forEach(cell=>{
          cell.classList.remove(...Object.values(codeMap).map(m=>m.class));
          cell.classList.add('code-empty');
          cell.textContent = '—';
        });
        updateStudentNameHighlight(i);
      });
      localStorage.removeItem(STATE_KEY);
      localStorage.setItem(LAST_RESET_KEY, todayStr());
      console.log('Behavior register: midnight reset performed at', new Date().toISOString());
    }

    function scheduleMidnightReset(){
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
      const ms = next - now;
      setTimeout(()=>{
        performReset();
        scheduleMidnightReset();
      }, ms + 1000);
      console.log('Scheduled midnight reset in ms:', ms);
    }

    const SERVER_BASE = 'http://localhost:4000';

    async function tryLoadFromServer(){
      try{
        const resp = await fetch(SERVER_BASE + '/api/state/behavior');
        if(!resp.ok) return false;
        const json = await resp.json();
        if(json && json.data){
          const payload = json.data;
          if(Array.isArray(payload)){
            payload.forEach(item=>{
              students[item.idx].cells = item.cells || [];
              item.cells.forEach((code,ci)=>{
                const cell = document.querySelector(`.behavior-cell[data-r="${item.idx}"][data-c="${ci}"]`);
                if(cell){
                  cell.classList.remove(...Object.values(codeMap).map(m=>m.class));
                  cell.classList.add(codeMap[code].class);
                  cell.textContent = codeMap[code].label;
                }
                updateDetentionStatus(item.idx);
              });
            });
            console.log('Loaded behaviour from server');
            return true;
          }
        }
      }catch(e){ /* ignore */ }
      return false;
    }

    async function trySaveToServer(){
      try{
        const payload = students.map((s,i)=>({ idx: i, cells: s.cells }));
        const resp = await fetch(SERVER_BASE + '/api/state/behavior', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        return resp.ok;
      }catch(e){ return false; }
    }

    (async function initPersistence(){
      const loaded = await tryLoadFromServer();
      if(!loaded){
        const last = localStorage.getItem(LAST_RESET_KEY);
        if(!last || last < todayStr()){
          performReset();
        } else {
          loadState();
        }
      }
      scheduleMidnightReset();
    })();

    // actions
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const ok = await trySaveToServer();
      if(!ok) saveState();
      alert('Register saved. ' + students.filter(s=>s.detained).length + ' students in detention.');
    });

    document.getElementById('backBtn').addEventListener('click', ()=>alert('Going back to register (simulated)'));
    document.getElementById('closeBtn').addEventListener('click', ()=>alert('Close (simulated)'));
    document.getElementById('undoBtn').addEventListener('click', ()=>location.reload());
  </script>
</body>
</html>
