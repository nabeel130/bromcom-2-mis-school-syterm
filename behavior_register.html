<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Behaviour Register — MIS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--blue:#1e88e5;--accent:#00a9a5;--muted:#6b7280;--bg:#f7fafc;--card:#fff;--danger:#ef4444;--highlight:#fff59d}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, 'Segoe UI', Arial;background:var(--bg);color:#1f2937}
    .layout{display:flex;min-height:100vh}

    /* Left vertical nav */
    .leftnav{width:72px;background:linear-gradient(180deg,var(--blue),#0b5fb3);color:#fff;display:flex;flex-direction:column;align-items:center;padding:18px 8px;gap:12px}
    .leftnav a{color:#fff;text-decoration:none;display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px}
    .leftnav .logo{font-weight:800;color:#fff;font-size:18px;margin-bottom:6px}

    /* Main content */
    .main{flex:1;padding:18px}
    .top-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{padding:10px 14px;border-radius:6px;border:0;cursor:pointer;font-weight:700}
    .btn.save{background:#22c55e;color:#fff}
    .btn.close{background:#1f2937;color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}

    .meta{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .meta .date-pill{background:#e6f2ff;color:var(--blue);padding:6px 10px;border-radius:999px;font-weight:700}

    .grid-wrap{display:flex;gap:14px}

    /* Student list + date grid */
    .register{flex:1;background:var(--card);border-radius:8px;padding:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);overflow:auto}
    .register table{width:100%;border-collapse:collapse;font-size:13px}
    .register thead th{position:sticky;top:0;background:#f1f6fb;padding:10px;border-bottom:1px solid #e6eef9;text-align:left}
    .register tbody td{padding:10px;border-bottom:1px solid #f0f4f8}
    .name-col{width:260px;font-weight:700}
    .smallcol{width:48px;text-align:center}

    /* many date columns: compact style */
    .date-cell{width:56px;height:44px;text-align:center;vertical-align:middle;cursor:pointer;border-radius:6px;background:transparent}
    .date-cell.q{color:var(--muted)}
    .date-cell.present{background:#e6f4ea;color:#0f5132;font-weight:800}
    .date-cell.slash{background:#fff6e6;color:#8a5800;font-weight:800}
    .date-cell.highlight{background:var(--highlight)}
    .date-cell.now{background:#cfe8ff}

    /* right sidebar student info */
    .sidebar{width:300px;background:var(--card);border-radius:8px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06);height:fit-content}
    .avatar{width:96px;height:96px;border-radius:999px;background:#e8eefb;margin:auto}
    .s-info{text-align:center;margin-top:10px}
    .s-info h3{margin:6px 0}
    .stat{display:flex;justify-content:space-between;padding:6px 0;border-top:1px solid #f1f4f8;margin-top:12px;color:var(--muted)}

    /* footer */
    .legend{margin-top:12px;font-size:13px;color:var(--muted)}

    @media (max-width:960px){.grid-wrap{flex-direction:column}.sidebar{width:100%}}
  </style>
</head>
<body>
  <div class="layout">
    <nav class="leftnav">
      <div class="logo">B</div>
      <a title="Home" href="#"><i class="fas fa-home"></i></a>
      <a title="Students" href="#"><i class="fas fa-user-graduate"></i></a>
      <a title="Reports" href="#"><i class="fas fa-chart-bar"></i></a>
      <a title="Config" href="#"><i class="fas fa-cog"></i></a>
    </nav>

    <main class="main">
      <div class="top-actions">
        <button class="btn save" id="saveBtn"><i class="fas fa-save"></i> Save</button>
        <button class="btn close" id="closeBtn"><i class="fas fa-times"></i> Close</button>
        <button class="btn ghost" id="undoBtn"><i class="fas fa-rotate-left"></i> Undo</button>
        <button class="btn ghost" id="backBtn"><i class="fas fa-arrow-left"></i> Go Back to Register</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <div class="date-pill">Fri, 29/01/21 AM</div>
          <div class="small-muted">27 of 29 Present</div>
        </div>
      </div>

      <div class="grid-wrap">
        <section class="register">
          <table id="regTable">
            <thead>
              <tr>
                <th class="name-col">Student Name</th>
                <th class="smallcol">TLT</th>
                <!-- date columns generated by JS -->
              </tr>
            </thead>
            <tbody id="regBody">
              <!-- rows by JS -->
            </tbody>
          </table>
        </section>

        <aside class="sidebar">
          <div class="avatar"></div>
          <div class="s-info">
            <h3 id="sideName">IOLA VARSANI</h3>
            <div class="sub" id="sideDob">02/01/2013</div>
            <div class="sub" id="sideId">YRG3 - 3W-00008432</div>
          </div>
          <div class="stat"><div>Attendance (All)</div><div id="allPct">0%</div></div>
          <div class="stat"><div>Class</div><div id="classPct">0%</div></div>
          <div class="stat"><div>AM/PM</div><div id="amppct">0%</div></div>
          <div class="legend">Legend: <strong>?</strong>=Unknown &nbsp; <strong>/</strong>=Unauth &nbsp; <strong>P</strong>=Present</div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    // Build example register with many date columns like the screenshot
    const students = [
      'ALI, VICTORIA','BATESON, KIRSTY','BURNS, ANJALI','DARBAR, OWEN','DEVLIN, EMMA','DHLIWAYO, JAMES','DOBSON, DANIEL','DUGDILL, SEETLE','FIGGINS, MUHAMMED-ALI','FOSTER, LYNN','FOSTER, YASHVI','GOODIER, HARRIS','GREENHALGH, NATHAN','HIRANI, GARY'
    ].map((n,i)=>({id:100+i,name:n,tlt: i%3===0? '♠':'' ,cells:[] }));

    // generate a set of columns (dates) to mimic many AM/PM columns
    const columns = [];
    for(let i=0;i<14;i++){
      // label sample: Mo 25 AM
      const weekday = ['Mo','Tu','We','Th','Fr','Sa','Su'][i%7];
      const day = 25 + Math.floor(i/2);
      const part = (i%2===0)?'AM':'PM';
      columns.push(`${weekday} ${day} ${part}`);
    }

    // insert date headers
    const theadRow = document.querySelector('#regTable thead tr');
    columns.forEach((c,idx)=>{
      const th = document.createElement('th');
      th.innerHTML = `<div style="display:flex;flex-direction:column"><small style="color:var(--muted);font-weight:600">${c}</small></div>`;
      theadRow.appendChild(th);
    });

    // populate rows
    const tbody = document.getElementById('regBody');
    students.forEach((s,si)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="font-weight:700">${s.name} ${s.tlt?'<span style="margin-left:8px;color:#f59e0b">'+s.tlt+'</span>':''}</td><td style="text-align:center">${si%4===0? 'i':''}</td>`;
      columns.forEach((col,ci)=>{
        const td = document.createElement('td');
        td.className = 'date-cell q';
        td.textContent = '?';
        td.dataset.r = si; td.dataset.c = ci;
        // highlight one column (like screenshot)
        if(ci===8){ td.classList.add('highlight'); }
        if(ci===9){ td.classList.add('now'); }
        td.addEventListener('click', onCellClick);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    function onCellClick(e){
      const el = e.currentTarget;
      // cycle through states: ? -> / -> P -> ?
      if(el.textContent==='?'){
        el.textContent='/'; el.classList.remove('q'); el.classList.add('slash');
      } else if(el.textContent==='/' ){
        el.textContent='P'; el.classList.remove('slash'); el.classList.add('present');
      } else if(el.textContent==='P'){
        el.textContent='?'; el.classList.remove('present'); el.classList.add('q');
      }
      // small demo: set sidebar to clicked student
      const r = el.dataset.r; const student = students[r];
      document.getElementById('sideName').textContent = student.name;

      // save each change to persisted state
      saveState();
    }

    // --- Persistence & Midnight Reset logic ---
    const STATE_KEY = 'behavior_register_state_v1';
    const LAST_RESET_KEY = 'behavior_register_lastReset_v1';

    function todayStr(){
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    function saveState(){
      // store values of all date cells
      const payload = [];
      document.querySelectorAll('.date-cell').forEach(cell=>{
        payload.push({r: cell.dataset.r, c: cell.dataset.c, v: cell.textContent});
      });
      localStorage.setItem(STATE_KEY, JSON.stringify(payload));
    }

    function loadState(){
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw) return false;
      try{
        const payload = JSON.parse(raw);
        payload.forEach(item=>{
          const sel = document.querySelector(`.date-cell[data-r="${item.r}"][data-c="${item.c}"]`);
          if(sel){
            sel.textContent = item.v;
            sel.classList.remove('q','slash','present');
            if(item.v === '?') sel.classList.add('q');
            if(item.v === '/') sel.classList.add('slash');
            if(item.v === 'P') sel.classList.add('present');
          }
        });
        return true;
      }catch(e){return false}
    }

    function performReset(){
      // reset all cells to '?' and clear persisted state
      document.querySelectorAll('.date-cell').forEach(cell=>{
        cell.textContent = '?';
        cell.classList.remove('slash','present');
        if(!cell.classList.contains('q')) cell.classList.add('q');
      });
      localStorage.removeItem(STATE_KEY);
      localStorage.setItem(LAST_RESET_KEY, todayStr());
      console.log('Behavior register: midnight reset performed at', new Date().toISOString());
    }

    function scheduleMidnightReset(){
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1); // midnight next
      const ms = next - now;
      setTimeout(()=>{
        performReset();
        // schedule subsequent
        scheduleMidnightReset();
      }, ms + 1000); // small buffer
      console.log('Scheduled midnight reset in ms:', ms);
    }

    // On load: try server first, otherwise fallback to localStorage
    const SERVER_BASE = 'http://localhost:4000';

    async function tryLoadFromServer(){
      try{
        const resp = await fetch(SERVER_BASE + '/api/state/behavior');
        if(!resp.ok) return false;
        const json = await resp.json();
        if(json && json.data){
          // apply server payload to DOM
          const payload = json.data; // expected array of {r,c,v}
          if(Array.isArray(payload)){
            payload.forEach(item=>{
              const sel = document.querySelector(`.date-cell[data-r="${item.r}"][data-c="${item.c}"]`);
              if(sel){
                sel.textContent = item.v;
                sel.classList.remove('q','slash','present');
                if(item.v === '?') sel.classList.add('q');
                if(item.v === '/') sel.classList.add('slash');
                if(item.v === 'P') sel.classList.add('present');
              }
            });
            console.log('Loaded behaviour from server');
            return true;
          }
        }
      }catch(e){ /* ignore */ }
      return false;
    }

    async function trySaveToServer(){
      try{
        const payload = [];
        document.querySelectorAll('.date-cell').forEach(cell=>{ payload.push({r:cell.dataset.r,c:cell.dataset.c,v:cell.textContent}); });
        const resp = await fetch(SERVER_BASE + '/api/state/behavior', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        return resp.ok;
      }catch(e){ return false; }
    }

    (async function initPersistence(){
      // try server
      const loaded = await tryLoadFromServer();
      if(!loaded){
        const last = localStorage.getItem(LAST_RESET_KEY);
        if(!last || last < todayStr()){
          performReset();
        } else {
          loadState();
        }
      }
      // schedule next automatic reset (local fallback)
      scheduleMidnightReset();
    })();

    // actions
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      // gather minimal payload (for console)
      const payload = [];
      document.querySelectorAll('.date-cell').forEach(cell=>{
        const r = cell.dataset.r; const c = cell.dataset.c;
        payload.push({row:r,col:c,value:cell.textContent});
      });
      // try server first, else persist locally
      const ok = await trySaveToServer();
      if(!ok) saveState();
      console.log('SAVE PAYLOAD', payload.slice(0,60));
      alert('Register saved (simulation). Check console for payload.');
    });

    document.getElementById('backBtn').addEventListener('click', ()=>alert('Going back to register (simulated)'));
    document.getElementById('closeBtn').addEventListener('click', ()=>alert('Close (simulated)'));
    document.getElementById('undoBtn').addEventListener('click', ()=>location.reload());
  </script>
</body>
</html>
